<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class Chstr - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link"><a href="Object.html">Object</a>
  
</div>

    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-i-ascend-21">#ascend!</a>
    
    <li ><a href="#method-i-attempt_move">#attempt_move</a>
    
    <li ><a href="#method-i-descend-21">#descend!</a>
    
    <li ><a href="#method-i-evaluate">#evaluate</a>
    
    <li ><a href="#method-i-generate_captures">#generate_captures</a>
    
    <li ><a href="#method-i-generate_json">#generate_json</a>
    
    <li ><a href="#method-i-generate_moves">#generate_moves</a>
    
    <li ><a href="#method-i-generate_root_evasions">#generate_root_evasions</a>
    
    <li ><a href="#method-i-generate_root_moves">#generate_root_moves</a>
    
    <li ><a href="#method-i-in_check-3F">#in_check?</a>
    
    <li ><a href="#method-i-init_search">#init_search</a>
    
    <li ><a href="#method-i-init_tables">#init_tables</a>
    
    <li ><a href="#method-i-input_move">#input_move</a>
    
    <li ><a href="#method-i-load_fen">#load_fen</a>
    
    <li ><a href="#method-i-make">#make</a>
    
    <li ><a href="#method-i-quiesce">#quiesce</a>
    
    <li ><a href="#method-i-root_make">#root_make</a>
    
    <li ><a href="#method-i-root_unmake">#root_unmake</a>
    
    <li ><a href="#method-i-search">#search</a>
    
    <li ><a href="#method-i-to_fen">#to_fen</a>
    
    <li ><a href="#method-i-unmake">#unmake</a>
    
    <li ><a href="#method-i-valid_root_moves">#valid_root_moves</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Chstr">
  <h1 id="class-Chstr" class="class">
    class Chstr
  </h1>

  <section class="description">
    
<p>All of <a href="Chstr.html">Chstr</a> resides in one class spread across
several files. Although this is clearly not in line with most Ruby
styleguides it seems to be the most efficient approach to avoiding many of
the pitfalls in Ruby performance. This file contains the functionality
involved in interfacing with the browser. The <a
href="Chstr.html">Chstr</a> object represents a move search from any
gamestate translated from a FEN string, although by tweaking a few lines <a
href="Chstr.html">Chstr</a> is capible of playing against itself in the
console.</p>

<p>Constants for different parts of the move search Many of them are just to
provide clarity, which is why there are four different constants for the
number 1</p>

<p>The sole evaluation function Evaluates the state of the current board in
respect to the side to move based on:</p>

<pre>- Pawn structure
- Positioning
- Material
- Mobility of sliding pieces
- Center control
- Piece/square tables ( see definitions.rb )
- Attack/defense mapping
- King safety</pre>

<p>All of the make and unmake operations involved in search deepening. 
Because of all of the instance variables already chewing on memory, only
moves at the root are considered for castling and en passant captures, to
allow these moves beyond the root, all of the irreversible gamestates would
have to be stored in memory (50 move rule, castling, ep square, etc.) or
tested for extensively</p>

<p>Generation of moves for the side to move.  Uses some simple heuristics to
order them in a way that should yield faster cutoffs (more pruning of the
search tree, less wasted evaluations).</p>

<pre>Types of moves: (see &#39;definitions.rb&#39;)
QUIET - not a capture or pawn move, increases the fifty move clock
CASTLE - castling move, either side, increases the fifty move clock
CAPTURE - resets fifty move clock
PAWN_PUSH - resets fifty move clock
DOUBLE_PAWN_PUSH - resets fifty move clock, sets ep square directly behind the &#39;to&#39; position</pre>

<p>Contains all of the search algorithms and data structures involved in a
Negascout search with iterative deepening.  Methods are clearly somehwat
lengthy for Ruby but this seems to be the most performant.</p>

  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="BISHOP">BISHOP
        
        <dd>
        
      
        <dt id="BLACK">BLACK
        
        <dd>
        
      
        <dt id="B_STEPS">B_STEPS
        
        <dd>
        
      
        <dt id="CAPTURE">CAPTURE
        
        <dd>
        
      
        <dt id="CASTLE">CASTLE
        
        <dd>
        
      
        <dt id="CNTR">CNTR
        
        <dd>
        
      
        <dt id="EMPTY">EMPTY
        
        <dd><p>colors, squares, and pieces</p>
        
      
        <dt id="EP_CAPTURE">EP_CAPTURE
        
        <dd>
        
      
        <dt id="FEN_CASTLE">FEN_CASTLE
        
        <dd>
        
      
        <dt id="FEN_COLOR">FEN_COLOR
        
        <dd>
        
      
        <dt id="FEN_SQUARES">FEN_SQUARES
        
        <dd>
        
      
        <dt id="FILE">FILE
        
        <dd>
        
      
        <dt id="FORWARD">FORWARD
        
        <dd><p>move calculation</p>
        
      
        <dt id="INF">INF
        
        <dd><p>miscellaneous utlity</p>
        
      
        <dt id="INIT">INIT
        
        <dd>
        
      
        <dt id="INIT_COLORS">INIT_COLORS
        
        <dd>
        
      
        <dt id="INIT_FEN">INIT_FEN
        
        <dd><p>fen utility</p>
        
      
        <dt id="INIT_SQUARES">INIT_SQUARES
        
        <dd>
        
      
        <dt id="INVALID">INVALID
        
        <dd>
        
      
        <dt id="KING">KING
        
        <dd>
        
      
        <dt id="KING_INITIAL">KING_INITIAL
        
        <dd>
        
      
        <dt id="KING_THREAT">KING_THREAT
        
        <dd>
        
      
        <dt id="KNIGHT">KNIGHT
        
        <dd>
        
      
        <dt id="KSC">KSC
        
        <dd>
        
      
        <dt id="LATE_GAME">LATE_GAME
        
        <dd>
        
      
        <dt id="MATERIAL">MATERIAL
        
        <dd><p>evaluation</p>
        
      
        <dt id="MAXPLY">MAXPLY
        
        <dd>
        
      
        <dt id="MID_GAME">MID_GAME
        
        <dd>
        
      
        <dt id="MOBILITY">MOBILITY
        
        <dd>
        
      
        <dt id="N_STEPS">N_STEPS
        
        <dd>
        
      
        <dt id="OTHER">OTHER
        
        <dd>
        
      
        <dt id="PAWN">PAWN
        
        <dd>
        
      
        <dt id="PAWN_DOUBLE_PUSH">PAWN_DOUBLE_PUSH
        
        <dd>
        
      
        <dt id="PAWN_PUSH">PAWN_PUSH
        
        <dd>
        
      
        <dt id="PIECES">PIECES
        
        <dd>
        
      
        <dt id="PST_END">PST_END
        
        <dd>
        
      
        <dt id="PST_MID">PST_MID
        
        <dd>
        
      
        <dt id="QSC">QSC
        
        <dd>
        
      
        <dt id="QUEEN">QUEEN
        
        <dd>
        
      
        <dt id="QUEEN_INITIAL">QUEEN_INITIAL
        
        <dd>
        
      
        <dt id="QUIET">QUIET
        
        <dd>
        
      
        <dt id="Q_STEPS">Q_STEPS
        
        <dd>
        
      
        <dt id="RANK">RANK
        
        <dd>
        
      
        <dt id="RAYS">RAYS
        
        <dd>
        
      
        <dt id="ROOK">ROOK
        
        <dd>
        
      
        <dt id="R_STEPS">R_STEPS
        
        <dd>
        
      
        <dt id="SLIDING">SLIDING
        
        <dd>
        
      
        <dt id="SQ">SQ
        
        <dd>
        
      
        <dt id="SQ120">SQ120
        
        <dd>
        
      
        <dt id="SQRND">SQRND
        
        <dd>
        
      
        <dt id="SQ_ID">SQ_ID
        
        <dd>
        
      
        <dt id="STEP">STEP
        
        <dd>
        
      
        <dt id="STEPS">STEPS
        
        <dd>
        
      
        <dt id="TYPES">TYPES
        
        <dd><p>flags for move types</p>
        
      
        <dt id="UTF8">UTF8
        
        <dd>
        
      
        <dt id="WHITE">WHITE
        
        <dd>
        
      
      </dl>
    </section>
    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(fen = INIT_FEN)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a new <a href="Chstr.html">Chstr</a> instance by loading a FEN
string The default parameter, <a href="Chstr.html#INIT_FEN">INIT_FEN</a> is
the starting position of a game:</p>

<pre class="ruby"><span class="ruby-string">&#39;rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1&#39;</span>
</pre>

<p>(see <a
href="https://en.wikipedia.org/wiki/Forsyth%E2%80%93Edwards_Notation">en.wikipedia.org/wiki/Forsyth%E2%80%93Edwards_Notation</a>)</p>
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/chstr.rb, line 13</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">fen</span> = <span class="ruby-constant">INIT_FEN</span>)
  <span class="ruby-identifier">load_fen</span>(<span class="ruby-identifier">fen</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-ascend-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ascend!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Adjusts variables one (half) move closer to the root of the search tree (0
ply)</p>
          
          

          
          <div class="method-source-code" id="ascend-21-source">
            <pre><span class="ruby-comment"># File lib/chstr/move.rb, line 174</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ascend!</span>
  <span class="ruby-ivar">@ply</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
  <span class="ruby-ivar">@ntm</span> = <span class="ruby-ivar">@wtm</span>
  <span class="ruby-ivar">@wtm</span> = <span class="ruby-ivar">@wtm</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-attempt_move" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">attempt_move</span><span
            class="method-args">(from, to, piece, target)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs a move, determining if the side to move will be in check after
doing so</p>
          
          

          
          <div class="method-source-code" id="attempt_move-source">
            <pre><span class="ruby-comment"># File lib/chstr/move.rb, line 154</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">attempt_move</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>)
  <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-identifier">piece</span>, <span class="ruby-ivar">@wtm</span>
  <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">from</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">from</span>] = <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EMPTY</span>

  <span class="ruby-ivar">@kings</span>[<span class="ruby-ivar">@wtm</span>] = <span class="ruby-identifier">to</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">KING</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_check?</span>
    <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">from</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">from</span>] = <span class="ruby-identifier">piece</span>, <span class="ruby-ivar">@wtm</span>
    <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-identifier">target</span>
    <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-identifier">target</span> <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span> <span class="ruby-operator">?</span> <span class="ruby-constant">EMPTY</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@ntm</span>

    <span class="ruby-ivar">@kings</span>[<span class="ruby-ivar">@wtm</span>] = <span class="ruby-identifier">from</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">KING</span>

    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-descend-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">descend!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Adjusts variables one (half) move deeper, further from the root</p>
          
          

          
          <div class="method-source-code" id="descend-21-source">
            <pre><span class="ruby-comment"># File lib/chstr/move.rb, line 181</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">descend!</span>
  <span class="ruby-ivar">@ply</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-ivar">@ntm</span> = <span class="ruby-ivar">@wtm</span>
  <span class="ruby-ivar">@wtm</span> = <span class="ruby-ivar">@wtm</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-evaluate" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">evaluate</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="evaluate-source">
            <pre><span class="ruby-comment"># File lib/chstr/evaluation.rb, line 12</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">evaluate</span>
  <span class="ruby-identifier">score</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">attacks</span> = []
  <span class="ruby-ivar">@nodes</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-ivar">@max_depth</span> = <span class="ruby-ivar">@ply</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@ply</span> <span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@max_depth</span>
  <span class="ruby-ivar">@npp</span>[<span class="ruby-ivar">@ply</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>

  <span class="ruby-constant">SQ</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-constant">EMPTY</span> }.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">from</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">color</span>, <span class="ruby-identifier">piece</span> = <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">from</span>], <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">from</span>]
    <span class="ruby-comment"># piece evaluation score starts with material value + piece square value</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@stage</span> <span class="ruby-operator">==</span> <span class="ruby-constant">MID_GAME</span>
      <span class="ruby-identifier">current</span> = <span class="ruby-constant">MATERIAL</span>[<span class="ruby-identifier">piece</span>] <span class="ruby-operator">+</span> <span class="ruby-constant">PST_MID</span>[<span class="ruby-identifier">piece</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-identifier">color</span>][<span class="ruby-identifier">from</span>]]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">current</span> = <span class="ruby-constant">MATERIAL</span>[<span class="ruby-identifier">piece</span>] <span class="ruby-operator">+</span> <span class="ruby-constant">PST_END</span>[<span class="ruby-identifier">piece</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-identifier">color</span>][<span class="ruby-identifier">from</span>]]
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">piece</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">PAWN</span>
      <span class="ruby-identifier">fwd</span> = <span class="ruby-constant">FORWARD</span>[<span class="ruby-identifier">color</span>]
      <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">fwd</span>
      <span class="ruby-comment"># penalty for pawns sharing a file</span>
      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">color</span>
        <span class="ruby-identifier">current</span> <span class="ruby-operator">-=</span> <span class="ruby-value">32</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">PAWN</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">fwd</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">color</span>
        <span class="ruby-identifier">current</span> <span class="ruby-operator">-=</span> <span class="ruby-value">32</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">fwd</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">PAWN</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-comment"># bonus for defensive positioning</span>
      [<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pos</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">color</span>
          <span class="ruby-identifier">attacks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-operator">-</span><span class="ruby-identifier">pos</span>
          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ROOK</span>
            <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">CNTR</span>[<span class="ruby-identifier">pos</span>]
            <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">CNTR</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">KNIGHT</span>
          <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">OTHER</span>[<span class="ruby-identifier">color</span>]
          <span class="ruby-identifier">attacks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">pos</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      [<span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">from</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pos</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">PAWN</span>
          <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">CNTR</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">color</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">when</span> <span class="ruby-constant">KNIGHT</span>
      <span class="ruby-constant">N_STEPS</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">step</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>
        <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">CNTR</span>[<span class="ruby-identifier">to</span>]
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">color</span>
          <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">CNTR</span>[<span class="ruby-identifier">to</span>]
          <span class="ruby-identifier">attacks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-operator">-</span><span class="ruby-identifier">to</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">OTHER</span>[<span class="ruby-identifier">color</span>]
          <span class="ruby-identifier">attacks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">to</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">when</span> <span class="ruby-constant">BISHOP</span>
      <span class="ruby-identifier">mobility</span> = <span class="ruby-value">0</span>

      <span class="ruby-constant">B_STEPS</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">step</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>

        <span class="ruby-keyword">while</span> <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">CNTR</span>[<span class="ruby-identifier">to</span>]
          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
            <span class="ruby-identifier">mobility</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
            <span class="ruby-identifier">to</span> = <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>
            <span class="ruby-keyword">next</span>

          <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">color</span>
            <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">CNTR</span>[<span class="ruby-identifier">to</span>]
            <span class="ruby-identifier">attacks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-operator">-</span><span class="ruby-identifier">to</span>
          <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">OTHER</span>[<span class="ruby-identifier">color</span>]
            <span class="ruby-identifier">attacks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">to</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">MOBILITY</span>[<span class="ruby-identifier">mobility</span>]

    <span class="ruby-keyword">when</span> <span class="ruby-constant">ROOK</span>
      <span class="ruby-identifier">mobility</span> = <span class="ruby-value">0</span>

      <span class="ruby-constant">R_STEPS</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">step</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>

        <span class="ruby-keyword">while</span> <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">CNTR</span>[<span class="ruby-identifier">to</span>]
          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
            <span class="ruby-identifier">mobility</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
            <span class="ruby-identifier">to</span> = <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>
            <span class="ruby-keyword">next</span>

          <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">color</span>
            <span class="ruby-identifier">attacks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-operator">-</span><span class="ruby-identifier">to</span>
            <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">CNTR</span>[<span class="ruby-identifier">to</span>]
          <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">OTHER</span>[<span class="ruby-identifier">color</span>]
            <span class="ruby-identifier">attacks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">to</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">MOBILITY</span>[<span class="ruby-identifier">mobility</span>]

    <span class="ruby-keyword">when</span> <span class="ruby-constant">QUEEN</span>
      <span class="ruby-identifier">mobility</span> = <span class="ruby-value">0</span>

      <span class="ruby-constant">Q_STEPS</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">step</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>

        <span class="ruby-keyword">while</span> <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">CNTR</span>[<span class="ruby-identifier">to</span>]
          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
            <span class="ruby-identifier">mobility</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
            <span class="ruby-identifier">to</span> = <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>
            <span class="ruby-keyword">next</span>

          <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">color</span>
            <span class="ruby-identifier">attacks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-operator">-</span><span class="ruby-identifier">to</span>
            <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">CNTR</span>[<span class="ruby-identifier">to</span>]
          <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">OTHER</span>[<span class="ruby-identifier">color</span>]
            <span class="ruby-identifier">attacks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">to</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">MOBILITY</span>[<span class="ruby-identifier">mobility</span>]
      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@full_moves</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@ply</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">10</span>
        <span class="ruby-identifier">current</span> <span class="ruby-operator">-=</span> <span class="ruby-value">16</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">from</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">QUEEN_INITIAL</span>[<span class="ruby-identifier">color</span>]
      <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">when</span> <span class="ruby-constant">KING</span>
      <span class="ruby-identifier">threat</span> = <span class="ruby-value">0</span>

      <span class="ruby-value">8</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">pos</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-constant">RAYS</span>[<span class="ruby-identifier">i</span>]

        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">color</span>
          <span class="ruby-identifier">attacks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-operator">-</span><span class="ruby-identifier">pos</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">OTHER</span>[<span class="ruby-identifier">color</span>]
          <span class="ruby-identifier">attacks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">pos</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">while</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
          <span class="ruby-identifier">pos</span> = <span class="ruby-identifier">pos</span> <span class="ruby-operator">+</span> <span class="ruby-constant">RAYS</span>[<span class="ruby-identifier">i</span>]
          <span class="ruby-identifier">threat</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">current</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">KING_THREAT</span>[<span class="ruby-identifier">threat</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">score</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">color</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@wtm</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">current</span> <span class="ruby-operator">:</span> <span class="ruby-operator">-</span><span class="ruby-identifier">current</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">score</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">attacks</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-identifier">attacks</span>.<span class="ruby-identifier">sort!</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">score</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">attacks</span>.<span class="ruby-identifier">last</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>

  <span class="ruby-identifier">j</span> = <span class="ruby-value">-1</span>
  <span class="ruby-identifier">attacks</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>

    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">attacks</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">-</span><span class="ruby-identifier">attacks</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">attacks</span>[<span class="ruby-identifier">j</span>]

    <span class="ruby-keyword">if</span> <span class="ruby-operator">-</span><span class="ruby-identifier">attacks</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">attacks</span>[<span class="ruby-identifier">j</span>]
      <span class="ruby-identifier">j</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">next</span>

    <span class="ruby-keyword">elsif</span> <span class="ruby-operator">-</span><span class="ruby-identifier">attacks</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">attacks</span>[<span class="ruby-identifier">j</span>]
      <span class="ruby-identifier">n</span> = <span class="ruby-value">16</span>
      <span class="ruby-identifier">pos</span> = <span class="ruby-identifier">attacks</span>[<span class="ruby-identifier">j</span>]
      <span class="ruby-identifier">j</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">attacks</span>[<span class="ruby-identifier">j</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">attacks</span>[<span class="ruby-identifier">j</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>]
        <span class="ruby-identifier">n</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">n</span>
        <span class="ruby-identifier">j</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">attacks</span>[<span class="ruby-identifier">j</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">attacks</span>[<span class="ruby-identifier">j</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>]
          <span class="ruby-identifier">n</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">n</span>
          <span class="ruby-identifier">j</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-constant">PAWN</span>
        <span class="ruby-identifier">n</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">n</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-constant">ROOK</span>
          <span class="ruby-identifier">n</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">n</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@wtm</span>
        <span class="ruby-identifier">score</span> <span class="ruby-operator">-=</span> <span class="ruby-identifier">n</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">score</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">n</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">score</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-generate_captures" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">generate_captures</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Generates only capturing moves.  Same thing as &#39;generate_moves&#39;,
but pickier. Orders moves from least valuable attacker &amp;&amp; most
valuable target to most valuable attacker and least valuable target.</p>
          
          

          
          <div class="method-source-code" id="generate_captures-source">
            <pre><span class="ruby-comment"># File lib/chstr/move_generation.rb, line 311</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">generate_captures</span>
  <span class="ruby-identifier">captures</span> = []
  <span class="ruby-constant">SQ</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">sq</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">sq</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@wtm</span> }.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">from</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">piece</span> = <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">from</span>]

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">PAWN</span>

      <span class="ruby-constant">STEPS</span>[<span class="ruby-identifier">piece</span>].<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">step</span> = <span class="ruby-constant">STEP</span>[<span class="ruby-identifier">piece</span>][<span class="ruby-identifier">j</span>]
        <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>

        <span class="ruby-keyword">while</span> <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">target</span> = <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>]
          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>

            <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">SLIDING</span>[<span class="ruby-identifier">piece</span>]
            <span class="ruby-identifier">to</span> = <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>
            <span class="ruby-keyword">next</span>

          <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
            <span class="ruby-identifier">captures</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>]
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]
      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
        <span class="ruby-identifier">captures</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>]]
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
        <span class="ruby-identifier">captures</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>]]
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">captures</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-constant">MATERIAL</span>[<span class="ruby-identifier">m</span>[<span class="ruby-value">3</span>]] <span class="ruby-operator">-</span> <span class="ruby-constant">MATERIAL</span>[<span class="ruby-identifier">m</span>[<span class="ruby-value">2</span>]] }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-generate_json" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">generate_json</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Generates a bunch of lovely stuff for the browser</p>
          
          

          
          <div class="method-source-code" id="generate_json-source">
            <pre><span class="ruby-comment"># File lib/chstr.rb, line 118</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">generate_json</span>
  <span class="ruby-identifier">npp_percentages</span> = []
  <span class="ruby-identifier">npp_max</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">npp_max_ply</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">time_elapsed</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@duration</span>.<span class="ruby-identifier">to_f</span>).<span class="ruby-identifier">round</span>(<span class="ruby-value">1</span>)
  <span class="ruby-identifier">moves</span> = []
  <span class="ruby-ivar">@npp</span>[<span class="ruby-value">1</span>, <span class="ruby-value">16</span>].<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">npp_max</span>
      <span class="ruby-identifier">npp_max</span> = <span class="ruby-identifier">i</span>
      <span class="ruby-identifier">npp_max_ply</span> = <span class="ruby-identifier">idx</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">npp_percentages</span> <span class="ruby-operator">&lt;&lt;</span> ((<span class="ruby-identifier">i</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> <span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">to_f</span>) <span class="ruby-operator">*</span> <span class="ruby-value">100.0</span>).<span class="ruby-identifier">round</span>(<span class="ruby-value">1</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">valid_moves</span> = <span class="ruby-identifier">valid_root_moves</span>
  <span class="ruby-constant">SQ</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">sq</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">sq</span>] <span class="ruby-operator">!=</span> <span class="ruby-constant">EMPTY</span>
      <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">color</span> = <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">sq</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">sq</span>]

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">color</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@wtm</span>
        <span class="ruby-identifier">current_moves</span> = <span class="ruby-identifier">valid_moves</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">sq</span> }.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-constant">SQ_ID</span>[<span class="ruby-identifier">m</span>[<span class="ruby-value">1</span>]] }
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">current_moves</span> = []
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-identifier">square</span><span class="ruby-operator">:</span> <span class="ruby-constant">SQ_ID</span>[<span class="ruby-identifier">sq</span>], <span class="ruby-identifier">moves</span><span class="ruby-operator">:</span> <span class="ruby-identifier">current_moves</span> }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">pv_length</span> = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@pv</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">m</span>, <span class="ruby-identifier">depth</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">pv_length</span> = <span class="ruby-identifier">depth</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  {
    <span class="ruby-identifier">fen</span><span class="ruby-operator">:</span> <span class="ruby-identifier">to_fen</span>,
    <span class="ruby-identifier">moves</span><span class="ruby-operator">:</span> <span class="ruby-identifier">moves</span>,
    <span class="ruby-identifier">from</span><span class="ruby-operator">:</span> <span class="ruby-constant">SQ_ID</span>[<span class="ruby-ivar">@best_move</span>[<span class="ruby-value">0</span>]],
    <span class="ruby-identifier">to</span><span class="ruby-operator">:</span> <span class="ruby-constant">SQ_ID</span>[<span class="ruby-ivar">@best_move</span>[<span class="ruby-value">1</span>]],
    <span class="ruby-identifier">npp</span><span class="ruby-operator">:</span> {
      <span class="ruby-identifier">count</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@npp</span>,
      <span class="ruby-identifier">percentages</span><span class="ruby-operator">:</span> <span class="ruby-identifier">npp_percentages</span>,
      <span class="ruby-identifier">pv</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@pv</span>[<span class="ruby-value">0</span>, <span class="ruby-value">16</span>]
    },
    <span class="ruby-identifier">report</span><span class="ruby-operator">:</span> {
      <span class="ruby-string">&#39;move&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{UTF8[WHITE][@best_move[2]]} #{SQ_ID[@best_move[0]]} #{SQ_ID[@best_move[1]]}&quot;</span>,
      <span class="ruby-string">&#39;move type&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">TYPES</span>[<span class="ruby-ivar">@best_move</span>[<span class="ruby-value">4</span>]],
      <span class="ruby-string">&#39;move score&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@best_score</span>,
      <span class="ruby-string">&#39;move changes&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@pv</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">count</span>,
      <span class="ruby-string">&#39;principal variation length&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">pv_length</span>,
      <span class="ruby-string">&#39;evaluation after move&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">evaluate</span>,
      <span class="ruby-string">&#39;evaluations&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@nodes</span>,
      <span class="ruby-string">&#39;evaluations per second&#39;</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@nodes</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">time_elapsed</span>).<span class="ruby-identifier">round</span>(<span class="ruby-value">1</span>),
      <span class="ruby-string">&#39;time elapsed&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">time_elapsed</span>,
      <span class="ruby-string">&#39;time allotted&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@duration</span>,
      <span class="ruby-string">&#39;max depth&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@max_depth</span>,
      <span class="ruby-string">&#39;median depth&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">npp_max_ply</span>,
      <span class="ruby-string">&#39;horizon depth&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@hrzn</span>,
      <span class="ruby-string">&#39;nodes at median&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">npp_max</span>
    }
  }.<span class="ruby-identifier">to_json</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-generate_moves" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">generate_moves</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Collects all sub-root moves, doesn&#39;t look for castling or en passant
capturing moves, orders them with several heuristics described below.</p>
          
          

          
          <div class="method-source-code" id="generate_moves-source">
            <pre><span class="ruby-comment"># File lib/chstr/move_generation.rb, line 246</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">generate_moves</span>
  <span class="ruby-identifier">moves</span> = []
  <span class="ruby-constant">SQ</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">sq</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">sq</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@wtm</span> }.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">from</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">piece</span> = <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">from</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">PAWN</span>

      <span class="ruby-constant">STEP</span>[<span class="ruby-identifier">piece</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">step</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>

        <span class="ruby-keyword">while</span> <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">target</span> = <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>]
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">target</span> <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
            <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-constant">EMPTY</span>]

            <span class="ruby-keyword">break</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">SLIDING</span>[<span class="ruby-identifier">piece</span>]
            <span class="ruby-identifier">to</span> = <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>
            <span class="ruby-keyword">next</span>

          <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
            <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>]
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]
      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
        <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>]]
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
        <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>]]
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
        <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-constant">EMPTY</span>]
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">from</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">80</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">40</span>
          <span class="ruby-identifier">to</span> = <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]
          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
            <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-constant">EMPTY</span>]
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">moves</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span>
    (
      <span class="ruby-comment"># bonus for captures, greater bonus for winning captures</span>
      (<span class="ruby-identifier">m</span>[<span class="ruby-value">3</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span> <span class="ruby-operator">?</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> (<span class="ruby-identifier">m</span>[<span class="ruby-value">3</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">m</span>[<span class="ruby-value">2</span>] <span class="ruby-operator">?</span> <span class="ruby-value">120</span> <span class="ruby-operator">:</span> <span class="ruby-value">60</span>)) <span class="ruby-operator">+</span>
      <span class="ruby-comment"># prioritize moves that have yielded cutoffs at this ply</span>
      (<span class="ruby-ivar">@kt</span>[<span class="ruby-ivar">@ply</span>][<span class="ruby-identifier">m</span>[<span class="ruby-value">2</span>]][<span class="ruby-identifier">m</span>[<span class="ruby-value">1</span>]] <span class="ruby-operator">*</span> <span class="ruby-value">8</span>) <span class="ruby-operator">+</span>
      <span class="ruby-comment"># prioritize moves that have yielded cutoffs one move (two ply) separated slightly less</span>
      (<span class="ruby-ivar">@kt</span>[<span class="ruby-ivar">@ply</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>][<span class="ruby-identifier">m</span>[<span class="ruby-value">2</span>]][<span class="ruby-identifier">m</span>[<span class="ruby-value">1</span>]] <span class="ruby-operator">*</span> <span class="ruby-value">4</span>) <span class="ruby-operator">+</span>
      <span class="ruby-comment"># and moves that have caused any cutoffs at all, at any depth, get a bonus</span>
      <span class="ruby-ivar">@ht</span>[<span class="ruby-identifier">m</span>[<span class="ruby-value">2</span>]][<span class="ruby-identifier">m</span>[<span class="ruby-value">1</span>]]
    <span class="ruby-comment"># divide everything by the number of times the move has not yielded anything significant</span>
    ) <span class="ruby-operator">/</span> <span class="ruby-ivar">@bt</span>[<span class="ruby-identifier">m</span>[<span class="ruby-value">2</span>]][<span class="ruby-identifier">m</span>[<span class="ruby-value">1</span>]] }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-generate_root_evasions" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">generate_root_evasions</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Collects moves for when in check, uses a different ordering method and
doesn&#39;t allow castling.  Prioritizes moves that block the path of the
attacker or capture it.</p>
          
          

          
          <div class="method-source-code" id="generate_root_evasions-source">
            <pre><span class="ruby-comment"># File lib/chstr/move_generation.rb, line 131</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">generate_root_evasions</span>
  <span class="ruby-identifier">paths</span>, <span class="ruby-identifier">moves</span> = [], []
  <span class="ruby-identifier">k</span> = <span class="ruby-ivar">@kings</span>[<span class="ruby-ivar">@wtm</span>]

  <span class="ruby-comment"># find the positions that block/capture the attacker</span>
  <span class="ruby-value">8</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">pos</span> = <span class="ruby-identifier">k</span> <span class="ruby-operator">+</span> <span class="ruby-constant">N_STEPS</span>[<span class="ruby-identifier">i</span>]
    <span class="ruby-comment"># check if the attacker is a knight</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">KNIGHT</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
      <span class="ruby-identifier">paths</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">pos</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">pos</span> = <span class="ruby-constant">RAYS</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">k</span>
    <span class="ruby-identifier">current_path</span> = []
    <span class="ruby-comment"># follow ray until either invalid square or a piece</span>
    <span class="ruby-keyword">while</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
      <span class="ruby-identifier">current_path</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">pos</span>
      <span class="ruby-identifier">pos</span> = <span class="ruby-identifier">pos</span> <span class="ruby-operator">+</span> <span class="ruby-constant">RAYS</span>[<span class="ruby-identifier">i</span>]
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># only matters if piece belongs to the opponent</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>

    <span class="ruby-identifier">current_path</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">pos</span>
    <span class="ruby-keyword">case</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">pos</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-constant">QUEEN</span>
      <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">current_path</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-constant">BISHOP</span>
      <span class="ruby-comment"># (-9, 9, -11, 11)</span>
      <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">current_path</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">4</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">ROOK</span>
      <span class="ruby-comment"># (-10, 10, -1, 1)</span>
      <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">current_path</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">PAWN</span>
      <span class="ruby-identifier">paths</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">pos</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">pos</span> <span class="ruby-operator">+</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@ntm</span>] <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">pos</span> <span class="ruby-operator">+</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@ntm</span>] <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">k</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">SQ</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">sq</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">sq</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@wtm</span> }.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">from</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">piece</span> = <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">from</span>]

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">PAWN</span>
      <span class="ruby-constant">STEPS</span>[<span class="ruby-identifier">piece</span>].<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">step</span> = <span class="ruby-constant">STEP</span>[<span class="ruby-identifier">piece</span>][<span class="ruby-identifier">j</span>]
        <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>

        <span class="ruby-keyword">while</span> <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">target</span> = <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>]
          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span>)
              <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-constant">QUIET</span>, <span class="ruby-value">100</span>]
            <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-constant">QUIET</span>, <span class="ruby-value">0</span>]
            <span class="ruby-keyword">end</span>

            <span class="ruby-keyword">break</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">SLIDING</span>[<span class="ruby-identifier">piece</span>]
            <span class="ruby-identifier">to</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">step</span>
            <span class="ruby-keyword">next</span>

          <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span>)
              <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-constant">CAPTURE</span>, <span class="ruby-value">110</span>]
            <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-constant">CAPTURE</span>, <span class="ruby-value">10</span>]
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>

      <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]

      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)
          <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>], <span class="ruby-constant">CAPTURE</span>, <span class="ruby-value">115</span>]
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>], <span class="ruby-constant">CAPTURE</span>, <span class="ruby-value">15</span>]
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)
          <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>], <span class="ruby-constant">CAPTURE</span>, <span class="ruby-value">115</span>]
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>], <span class="ruby-constant">CAPTURE</span>, <span class="ruby-value">15</span>]
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span>)
          <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">PAWN_PUSH</span>, <span class="ruby-value">100</span>]
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">PAWN_PUSH</span>, <span class="ruby-value">5</span>]
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">from</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">80</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">40</span>
          <span class="ruby-identifier">to</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]
          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span>)
              <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">PAWN_DOUBLE_PUSH</span>, <span class="ruby-value">105</span>]
            <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">PAWN_DOUBLE_PUSH</span>, <span class="ruby-value">10</span>]
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">moves</span>.<span class="ruby-identifier">sort_by</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-operator">-</span><span class="ruby-identifier">m</span>[<span class="ruby-value">5</span>] }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-generate_root_moves" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">generate_root_moves</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Collects all moves for the side to move, including castling and en passant
captures, most of the move ordering will be done after the initial search
before iterative deepening</p>
          
          

          
          <div class="method-source-code" id="generate_root_moves-source">
            <pre><span class="ruby-comment"># File lib/chstr/move_generation.rb, line 12</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">generate_root_moves</span>
  <span class="ruby-identifier">moves</span> = []
  <span class="ruby-identifier">check</span> = <span class="ruby-identifier">in_check?</span>

  <span class="ruby-constant">SQ</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">sq</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">sq</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@wtm</span> }.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">from</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">piece</span> = <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">from</span>]

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">PAWN</span>
      <span class="ruby-constant">STEP</span>[<span class="ruby-identifier">piece</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">step</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">step</span>

        <span class="ruby-keyword">while</span> <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">target</span> = <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>]

          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
            <span class="ruby-keyword">if</span> <span class="ruby-ivar">@state</span> <span class="ruby-operator">==</span> <span class="ruby-constant">MID_GAME</span>
              <span class="ruby-identifier">rating</span> = <span class="ruby-constant">PST_MID</span>[<span class="ruby-identifier">piece</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-ivar">@wtm</span>][<span class="ruby-identifier">to</span>]] <span class="ruby-operator">-</span> <span class="ruby-constant">PST_MID</span>[<span class="ruby-identifier">piece</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-ivar">@wtm</span>][<span class="ruby-identifier">from</span>]]
            <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">rating</span> = <span class="ruby-constant">PST_END</span>[<span class="ruby-identifier">piece</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-ivar">@wtm</span>][<span class="ruby-identifier">to</span>]] <span class="ruby-operator">-</span> <span class="ruby-constant">PST_END</span>[<span class="ruby-identifier">piece</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-ivar">@wtm</span>][<span class="ruby-identifier">from</span>]]
            <span class="ruby-keyword">end</span>

            <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-constant">QUIET</span>, <span class="ruby-identifier">rating</span>]

            <span class="ruby-keyword">if</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">KING</span>
              <span class="ruby-comment"># already know there is no check since that would result in &#39;generate_root_evasions&#39;</span>
              <span class="ruby-keyword">if</span> <span class="ruby-identifier">step</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@castling</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-constant">KSC</span>[<span class="ruby-ivar">@wtm</span>])
                <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
                  <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-constant">KING</span>, <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">CASTLE</span>, <span class="ruby-value">110</span>]
                <span class="ruby-keyword">end</span>

              <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">step</span> <span class="ruby-operator">==</span> <span class="ruby-value">-1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@castling</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-constant">QSC</span>[<span class="ruby-ivar">@wtm</span>])
                <span class="ruby-identifier">to</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
                <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
                  <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-constant">KING</span>, <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">CASTLE</span>, <span class="ruby-value">110</span>]
                <span class="ruby-keyword">end</span>
              <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>

            <span class="ruby-keyword">break</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">SLIDING</span>[<span class="ruby-identifier">piece</span>]

            <span class="ruby-identifier">to</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">step</span>
            <span class="ruby-keyword">next</span>

          <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
            <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">piece</span>
              <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-constant">CAPTURE</span>, <span class="ruby-value">130</span>]
            <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-constant">CAPTURE</span>, <span class="ruby-value">100</span>]
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># pawn moves</span>

      <span class="ruby-identifier">to</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]

      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-constant">PAWN</span>
          <span class="ruby-identifier">rating</span> = <span class="ruby-value">160</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">rating</span> = <span class="ruby-value">120</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>], <span class="ruby-constant">CAPTURE</span>, <span class="ruby-identifier">rating</span>]
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-constant">PAWN</span>
          <span class="ruby-identifier">rating</span> = <span class="ruby-value">160</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">rating</span> = <span class="ruby-value">120</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>], <span class="ruby-constant">CAPTURE</span>, <span class="ruby-identifier">rating</span>]
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@ep</span>
        <span class="ruby-comment"># if @ep isn&#39;t nil, and forward &amp;&amp; left or right is == @ep, then it can be captured</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@ep</span>
          <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EP_CAPTURE</span>, <span class="ruby-value">110</span>]
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@ep</span>
          <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EP_CAPTURE</span>, <span class="ruby-value">110</span>]
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@stage</span> <span class="ruby-operator">==</span> <span class="ruby-constant">MID_GAME</span>
          <span class="ruby-identifier">rating</span> = <span class="ruby-constant">PST_MID</span>[<span class="ruby-constant">PAWN</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-ivar">@wtm</span>][<span class="ruby-identifier">to</span>]] <span class="ruby-operator">-</span> <span class="ruby-constant">PST_MID</span>[<span class="ruby-constant">PAWN</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-ivar">@wtm</span>][<span class="ruby-identifier">from</span>]]
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">rating</span> = <span class="ruby-constant">PST_END</span>[<span class="ruby-constant">PAWN</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-ivar">@wtm</span>][<span class="ruby-identifier">to</span>]] <span class="ruby-operator">-</span> <span class="ruby-constant">PST_END</span>[<span class="ruby-constant">PAWN</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-ivar">@wtm</span>][<span class="ruby-identifier">from</span>]]
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">PAWN_PUSH</span>, <span class="ruby-identifier">rating</span>]

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">from</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">80</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">40</span>
          <span class="ruby-identifier">to</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]

          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
            <span class="ruby-keyword">if</span> <span class="ruby-ivar">@stage</span> <span class="ruby-operator">==</span> <span class="ruby-constant">MID_GAME</span>
              <span class="ruby-identifier">rating</span> = <span class="ruby-constant">PST_MID</span>[<span class="ruby-constant">PAWN</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-ivar">@wtm</span>][<span class="ruby-identifier">to</span>]] <span class="ruby-operator">-</span> <span class="ruby-constant">PST_MID</span>[<span class="ruby-constant">PAWN</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-ivar">@wtm</span>][<span class="ruby-identifier">from</span>]]
            <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">rating</span> = <span class="ruby-constant">PST_END</span>[<span class="ruby-constant">PAWN</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-ivar">@wtm</span>][<span class="ruby-identifier">to</span>]] <span class="ruby-operator">-</span> <span class="ruby-constant">PST_END</span>[<span class="ruby-constant">PAWN</span>][<span class="ruby-constant">SQ120</span>[<span class="ruby-ivar">@wtm</span>][<span class="ruby-identifier">from</span>]]
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">moves</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-constant">PAWN</span>, <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">PAWN_DOUBLE_PUSH</span>, <span class="ruby-identifier">rating</span>]
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">moves</span>.<span class="ruby-identifier">sort_by</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-operator">-</span><span class="ruby-identifier">m</span>[<span class="ruby-value">5</span>] }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-in_check-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">in_check?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Determines if the side to move is in check, returns true immiediately upon
discovering check</p>
          
          

          
          <div class="method-source-code" id="in_check-3F-source">
            <pre><span class="ruby-comment"># File lib/chstr/move_generation.rb, line 353</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">in_check?</span>
  <span class="ruby-identifier">k</span> = <span class="ruby-ivar">@kings</span>[<span class="ruby-ivar">@wtm</span>]

  <span class="ruby-value">8</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">pos</span> = <span class="ruby-identifier">k</span> <span class="ruby-operator">+</span> <span class="ruby-constant">N_STEPS</span>[<span class="ruby-identifier">i</span>]
    <span class="ruby-comment"># check for knights</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">KNIGHT</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@ntm</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">pos</span> = <span class="ruby-constant">RAYS</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">k</span>
    <span class="ruby-comment"># follows the ray until a piece or the end of the board is found</span>
    <span class="ruby-keyword">while</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
      <span class="ruby-identifier">pos</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">RAYS</span>[<span class="ruby-identifier">i</span>]
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># ignore friendly pieces and invalid squares</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">pos</span>] <span class="ruby-operator">!=</span> <span class="ruby-ivar">@ntm</span>

    <span class="ruby-keyword">case</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">pos</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-constant">QUEEN</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">BISHOP</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">4</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">ROOK</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">PAWN</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">pos</span> <span class="ruby-operator">+</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@ntm</span>] <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">pos</span> <span class="ruby-operator">+</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@ntm</span>] <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">k</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-init_search" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">init_search</span><span
            class="method-args">(duration = 2)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Begins iterative deepening, uses a saved opening if possible.  Adjusts the
search window while deepening to ideally search less unnecessary nodes. 
Generates tables for the different heuristics involved in move ordering and
move generation.  Stores report data for relay to the browser.</p>
          
          

          
          <div class="method-source-code" id="init_search-source">
            <pre><span class="ruby-comment"># File lib/chstr/search.rb, line 9</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">init_search</span>(<span class="ruby-identifier">duration</span> = <span class="ruby-value">2</span>)
  <span class="ruby-ivar">@duration</span> = <span class="ruby-identifier">duration</span>
  <span class="ruby-identifier">init_tables</span>
  <span class="ruby-identifier">start_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>

  <span class="ruby-identifier">alpha</span>, <span class="ruby-identifier">beta</span> = <span class="ruby-operator">-</span><span class="ruby-constant">INF</span>, <span class="ruby-constant">INF</span>
  <span class="ruby-ivar">@best_score</span>, <span class="ruby-ivar">@best_move</span> = <span class="ruby-operator">-</span><span class="ruby-constant">INF</span>, <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">moves</span> = <span class="ruby-identifier">in_check?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">generate_root_evasions</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">generate_root_moves</span>

  <span class="ruby-identifier">initial</span> = <span class="ruby-keyword">true</span>

  <span class="ruby-comment"># don&#39;t go beyond MAXPLY, since it determines the array sizes</span>
  <span class="ruby-keyword">while</span> <span class="ruby-ivar">@hrzn</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">MAXPLY</span>
    <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
    <span class="ruby-keyword">while</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">moves</span>.<span class="ruby-identifier">length</span>
      <span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">rating</span> = <span class="ruby-identifier">moves</span>[<span class="ruby-identifier">i</span>]
      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">root_make</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">type</span>)
        <span class="ruby-comment"># get rid of moves that give self check</span>
        <span class="ruby-identifier">moves</span>.<span class="ruby-identifier">delete_at</span>(<span class="ruby-identifier">i</span>)
        <span class="ruby-keyword">next</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">initial</span>
        <span class="ruby-ivar">@pv</span>[<span class="ruby-ivar">@ply</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">SQ_ID</span>[<span class="ruby-constant">SQ120</span>[<span class="ruby-value">1</span>][<span class="ruby-identifier">to</span>]]
        <span class="ruby-comment"># search full depth for the principal variation (current best path from the root)</span>
        <span class="ruby-identifier">score</span> = <span class="ruby-operator">-</span><span class="ruby-identifier">search</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">beta</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">alpha</span>, <span class="ruby-ivar">@hrzn</span>, <span class="ruby-keyword">true</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-comment"># null window search</span>
        <span class="ruby-identifier">score</span> = <span class="ruby-operator">-</span><span class="ruby-identifier">search</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">alpha</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">alpha</span>, <span class="ruby-ivar">@hrzn</span>, <span class="ruby-keyword">false</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@best_score</span>
          <span class="ruby-ivar">@pv</span>[<span class="ruby-ivar">@ply</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">SQ_ID</span>[<span class="ruby-constant">SQ120</span>[<span class="ruby-value">1</span>][<span class="ruby-identifier">to</span>]]
          <span class="ruby-comment"># found a new principal variation, search it fully</span>
          <span class="ruby-identifier">score</span> = <span class="ruby-operator">-</span><span class="ruby-identifier">search</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">beta</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">alpha</span>, <span class="ruby-ivar">@hrzn</span>, <span class="ruby-keyword">true</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">initial</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@full_moves</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">10</span>
        <span class="ruby-comment"># check for a book position on first round, randomize for less repetitive behavior</span>
        <span class="ruby-identifier">fen</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_fen</span>.<span class="ruby-identifier">split</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&quot;/&quot;</span>, <span class="ruby-string">&#39;&#39;</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">@@book</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">fen</span>)
          <span class="ruby-identifier">score</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">INF</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">rand</span>(<span class="ruby-value">32</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">root_unmake</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">type</span>)
      <span class="ruby-comment"># use the score in the next iteration for ordering</span>
      <span class="ruby-identifier">moves</span>[<span class="ruby-identifier">i</span>][<span class="ruby-value">5</span>] = <span class="ruby-identifier">score</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">alpha</span>
        <span class="ruby-identifier">alpha</span> = <span class="ruby-identifier">score</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@best_score</span>
          <span class="ruby-ivar">@best_score</span> = <span class="ruby-identifier">score</span>
          <span class="ruby-ivar">@best_move</span> = [<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">score</span>]
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># adjust faulty windows</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">beta</span>
          <span class="ruby-identifier">beta</span> = <span class="ruby-constant">INF</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">alpha</span>
          <span class="ruby-identifier">alpha</span> = <span class="ruby-operator">-</span><span class="ruby-constant">INF</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">i</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">start_time</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@duration</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">moves</span> = <span class="ruby-identifier">moves</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-operator">-</span><span class="ruby-identifier">m</span>[<span class="ruby-value">5</span>] }
    <span class="ruby-identifier">initial</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-comment"># adjust windows</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@best_score</span> <span class="ruby-operator">&gt;</span> <span class="ruby-operator">-</span><span class="ruby-constant">INF</span>
      <span class="ruby-identifier">alpha</span> = <span class="ruby-ivar">@best_score</span> <span class="ruby-operator">-</span> <span class="ruby-value">64</span>
      <span class="ruby-identifier">beta</span> = <span class="ruby-ivar">@best_score</span> <span class="ruby-operator">+</span> <span class="ruby-value">64</span>
      <span class="ruby-ivar">@hrzn</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># break if out of time or a book move is found</span>
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">start_time</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@duration</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@best_score</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">INF</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># no move available means checkmate</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@best_move</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># adjust irreversibles</span>
  <span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">score</span> = <span class="ruby-ivar">@best_move</span>
  <span class="ruby-ivar">@ep</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@full_moves</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-constant">PAWN_DOUBLE_PUSH</span>
    <span class="ruby-ivar">@ep</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">ROOK</span>
    <span class="ruby-ivar">@castling</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">from</span>)
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">KING</span>
    <span class="ruby-ivar">@castling</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-constant">QSC</span>[<span class="ruby-ivar">@wtm</span>])
    <span class="ruby-ivar">@castling</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-constant">KSC</span>[<span class="ruby-ivar">@wtm</span>])
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@fifty</span> = <span class="ruby-identifier">type</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">?</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@fifty</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">root_make</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">type</span>)
  <span class="ruby-ivar">@evaluation</span> = <span class="ruby-identifier">evaluate</span>
  <span class="ruby-ivar">@clock</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">start_time</span>

  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-init_tables" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">init_tables</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="init_tables-source">
            <pre><span class="ruby-comment"># File lib/chstr/search.rb, line 204</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">init_tables</span>
  <span class="ruby-comment"># all cutoffs</span>
  <span class="ruby-ivar">@ht</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">6</span>){ <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">120</span>){ <span class="ruby-value">1</span> }}
  <span class="ruby-comment"># all non cutoffs</span>
  <span class="ruby-ivar">@bt</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">6</span>){ <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">120</span>){ <span class="ruby-value">1</span> }}
  <span class="ruby-comment"># all cutoffs @ ply</span>
  <span class="ruby-ivar">@kt</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">MAXPLY</span>){ <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">6</span>){ <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">120</span>){ <span class="ruby-value">1</span> }}}
  <span class="ruby-comment"># move cache</span>
  <span class="ruby-ivar">@mv</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">MAXPLY</span>){ [] }
  <span class="ruby-comment"># progress</span>
  <span class="ruby-ivar">@stage</span> = <span class="ruby-constant">SQ</span>.<span class="ruby-identifier">count</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">!=</span> <span class="ruby-constant">EMPTY</span> } <span class="ruby-operator">&lt;</span> <span class="ruby-value">16</span> <span class="ruby-operator">?</span> <span class="ruby-constant">LATE_GAME</span> <span class="ruby-operator">:</span> <span class="ruby-constant">MID_GAME</span>
  <span class="ruby-comment"># horizon depth / search depth to perform quiescence search</span>
  <span class="ruby-ivar">@hrzn</span> = <span class="ruby-value">1</span>
  <span class="ruby-comment"># node counter</span>
  <span class="ruby-ivar">@nodes</span> = <span class="ruby-value">0</span>
  <span class="ruby-comment"># nodes per ply</span>
  <span class="ruby-ivar">@npp</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">MAXPLY</span>){ <span class="ruby-value">0</span> }
  <span class="ruby-comment"># current ply</span>
  <span class="ruby-ivar">@ply</span> = <span class="ruby-value">0</span>
  <span class="ruby-comment"># greatest ply searched</span>
  <span class="ruby-ivar">@max_depth</span> = <span class="ruby-value">0</span>
  <span class="ruby-comment"># move the computer has chosen, for browser</span>
  <span class="ruby-ivar">@best_move</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@best_score</span> = <span class="ruby-operator">-</span><span class="ruby-constant">INF</span>
  <span class="ruby-ivar">@duration</span> = <span class="ruby-value">4</span>
  <span class="ruby-ivar">@pv</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">MAXPLY</span>){ [] }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-input_move" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">input_move</span><span
            class="method-args">(from_id, to_id)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Takes a move gathered from the browser and applies it to the current
gamestate</p>
          
          

          
          <div class="method-source-code" id="input_move-source">
            <pre><span class="ruby-comment"># File lib/chstr.rb, line 18</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">input_move</span>(<span class="ruby-identifier">from_id</span>, <span class="ruby-identifier">to_id</span>)
  <span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span> = <span class="ruby-constant">SQ_ID</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">from_id</span>), <span class="ruby-constant">SQ_ID</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">to_id</span>)
  <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span> = <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">from</span>], <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>]
  <span class="ruby-identifier">type</span>, <span class="ruby-ivar">@ep</span> = <span class="ruby-constant">QUIET</span>, <span class="ruby-keyword">nil</span>
  <span class="ruby-comment"># update irreversibles</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">PAWN</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">from</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">to</span>).<span class="ruby-identifier">abs</span> <span class="ruby-operator">==</span> <span class="ruby-value">20</span>
      <span class="ruby-identifier">type</span> = <span class="ruby-constant">PAWN_DOUBLE_PUSH</span>
      <span class="ruby-ivar">@ep</span> = <span class="ruby-identifier">from</span> <span class="ruby-operator">+</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">from</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">to</span>).<span class="ruby-identifier">abs</span> <span class="ruby-operator">==</span> <span class="ruby-value">10</span>
      <span class="ruby-identifier">type</span> = <span class="ruby-constant">PAWN_PUSH</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">from</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">to</span>).<span class="ruby-identifier">abs</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-identifier">type</span> = <span class="ruby-constant">EP_CAPTURE</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-ivar">@fifty</span> = <span class="ruby-value">0</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">ROOK</span>
    <span class="ruby-ivar">@castling</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">from</span>)
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">KING</span>
    <span class="ruby-ivar">@castling</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-constant">KSC</span>[<span class="ruby-ivar">@wtm</span>])
    <span class="ruby-ivar">@castling</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-constant">QSC</span>[<span class="ruby-ivar">@wtm</span>])
    <span class="ruby-identifier">type</span> = <span class="ruby-constant">CASTLE</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">from</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">to</span>).<span class="ruby-identifier">abs</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">target</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">EMPTY</span>
    <span class="ruby-identifier">type</span> = <span class="ruby-constant">CAPTURE</span>
    <span class="ruby-ivar">@fifty</span> = <span class="ruby-value">0</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">PAWN</span>
    <span class="ruby-ivar">@fifty</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">root_make</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">type</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-load_fen" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">load_fen</span><span
            class="method-args">(fen)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Parses and creates a set of instance variables that will be used during the
move search.</p>
          
          

          
          <div class="method-source-code" id="load_fen-source">
            <pre><span class="ruby-comment"># File lib/chstr.rb, line 52</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">load_fen</span>(<span class="ruby-identifier">fen</span>)
  <span class="ruby-identifier">sect</span> = <span class="ruby-identifier">fen</span>.<span class="ruby-identifier">split</span>
  <span class="ruby-ivar">@colors</span>, <span class="ruby-ivar">@squares</span> = <span class="ruby-constant">INIT</span>.<span class="ruby-identifier">dup</span>, <span class="ruby-constant">INIT</span>.<span class="ruby-identifier">dup</span>

  <span class="ruby-identifier">sect</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;/&quot;</span>).
    <span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">chars</span>.
    <span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span> <span class="ruby-constant">RANK</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">j</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">j</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">times</span>.
    <span class="ruby-identifier">map</span> { <span class="ruby-value">6</span> } <span class="ruby-operator">:</span> <span class="ruby-identifier">j</span> }}.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">sq</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">sq</span> <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
      <span class="ruby-ivar">@colors</span>[<span class="ruby-constant">SQ</span>[<span class="ruby-identifier">i</span>]], <span class="ruby-ivar">@squares</span>[<span class="ruby-constant">SQ</span>[<span class="ruby-identifier">i</span>]] = <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EMPTY</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@colors</span>[<span class="ruby-constant">SQ</span>[<span class="ruby-identifier">i</span>]] = <span class="ruby-identifier">sq</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sq</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">?</span> <span class="ruby-constant">BLACK</span> <span class="ruby-operator">:</span> <span class="ruby-constant">WHITE</span>
      <span class="ruby-ivar">@squares</span>[<span class="ruby-constant">SQ</span>[<span class="ruby-identifier">i</span>]] = <span class="ruby-constant">FEN_SQUARES</span>[<span class="ruby-constant">BLACK</span>].<span class="ruby-identifier">index</span>(<span class="ruby-identifier">sq</span>.<span class="ruby-identifier">downcase</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@kings</span> = [ <span class="ruby-constant">SQ</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">WHITE</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">KING</span> },
             <span class="ruby-constant">SQ</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">BLACK</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">KING</span> } ]

  <span class="ruby-ivar">@wtm</span> = <span class="ruby-constant">FEN_COLOR</span>[<span class="ruby-identifier">sect</span>[<span class="ruby-value">1</span>]]
  <span class="ruby-ivar">@ntm</span> = <span class="ruby-constant">OTHER</span>[<span class="ruby-ivar">@wtm</span>]
  <span class="ruby-ivar">@castling</span> = []
  <span class="ruby-constant">FEN_CASTLE</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">letter</span>, <span class="ruby-identifier">square</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@castling</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">square</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">sect</span>[<span class="ruby-value">2</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">letter</span>) }

  <span class="ruby-ivar">@ep</span> = <span class="ruby-identifier">sect</span>[<span class="ruby-value">3</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;-&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-constant">SQ_ID</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">sect</span>[<span class="ruby-value">3</span>])
  <span class="ruby-ivar">@fifty</span> = <span class="ruby-identifier">sect</span>[<span class="ruby-value">4</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-ivar">@full_moves</span> = <span class="ruby-identifier">sect</span>[<span class="ruby-value">5</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-ivar">@ply</span> = <span class="ruby-value">0</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-make" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">make</span><span
            class="method-args">(from, to, piece, target)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs a sub-root move, &#39;attempt_move&#39; handles most of it</p>
          
          

          
          <div class="method-source-code" id="make-source">
            <pre><span class="ruby-comment"># File lib/chstr/move.rb, line 133</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">make</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attempt_move</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>)

  <span class="ruby-identifier">descend!</span>

  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-quiesce" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">quiesce</span><span
            class="method-args">(alpha, beta)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs a quiescence search, used to evaluate beyond the &#39;horizon&#39;
to avoid misleading evaluations (see: <a
href="https://en.wikipedia.org/wiki/Quiescence_search">en.wikipedia.org/wiki/Quiescence_search</a>)</p>
          
          

          
          <div class="method-source-code" id="quiesce-source">
            <pre><span class="ruby-comment"># File lib/chstr/search.rb, line 169</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">quiesce</span>(<span class="ruby-identifier">alpha</span>, <span class="ruby-identifier">beta</span>)
  <span class="ruby-identifier">score</span> = <span class="ruby-identifier">evaluate</span>
  <span class="ruby-comment"># too good</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">beta</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">beta</span>
  <span class="ruby-comment"># just right</span>
  <span class="ruby-identifier">alpha</span> = <span class="ruby-identifier">score</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">alpha</span>
  <span class="ruby-comment"># too deep</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">alpha</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@ply</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-constant">MAXPLY</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>

  <span class="ruby-ivar">@mv</span>[<span class="ruby-ivar">@ply</span>] = <span class="ruby-identifier">generate_captures</span>
  <span class="ruby-keyword">while</span> <span class="ruby-ivar">@mv</span>[<span class="ruby-ivar">@ply</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span> = <span class="ruby-ivar">@mv</span>[<span class="ruby-ivar">@ply</span>].<span class="ruby-identifier">pop</span>
    <span class="ruby-comment"># ignore moves that are very unlikely to raise alpha</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">MATERIAL</span>[<span class="ruby-identifier">target</span>] <span class="ruby-operator">+</span> <span class="ruby-value">128</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">alpha</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">make</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>)

    <span class="ruby-identifier">score</span> = <span class="ruby-operator">-</span><span class="ruby-identifier">quiesce</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">beta</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">alpha</span>)

    <span class="ruby-identifier">unmake</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">alpha</span>
      <span class="ruby-ivar">@ht</span>[<span class="ruby-identifier">piece</span>][<span class="ruby-identifier">to</span>] <span class="ruby-operator">+=</span> <span class="ruby-ivar">@hrzn</span>

      <span class="ruby-keyword">return</span> <span class="ruby-identifier">beta</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">beta</span>

      <span class="ruby-identifier">alpha</span> = <span class="ruby-identifier">score</span>
      <span class="ruby-ivar">@kt</span>[<span class="ruby-ivar">@ply</span>][<span class="ruby-identifier">piece</span>][<span class="ruby-identifier">to</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">2</span><span class="ruby-operator">**</span><span class="ruby-ivar">@hrzn</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@bt</span>[<span class="ruby-identifier">piece</span>][<span class="ruby-identifier">to</span>] <span class="ruby-operator">+=</span> <span class="ruby-ivar">@hrzn</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">alpha</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-root_make" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">root_make</span><span
            class="method-args">(from, to, piece, target, type)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Attempts to make a move from at the root of the search tree (ply 0).  At
this point all moves are pseudolegal (see &#39;generate_root_moves&#39; /
&#39;generate_root_evasions&#39;), no castling moves are generated if
already in check.</p>
          
          

          
          <div class="method-source-code" id="root_make-source">
            <pre><span class="ruby-comment"># File lib/chstr/move.rb, line 28</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">root_make</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">type</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attempt_move</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">KING</span>
    <span class="ruby-comment"># we already know that the rook is there since the move was generated and @castling includes</span>
    <span class="ruby-comment"># the rook&#39;s square</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-constant">CASTLE</span>

      <span class="ruby-comment"># queen side castle</span>
      <span class="ruby-comment"># R _ x _ K _ _ _ -&gt;  _ _ K R _ _ _ _</span>
      <span class="ruby-comment"># a b c d e f g h     a b c d e f g h</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">from</span>
        <span class="ruby-comment"># try the middle square</span>
        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-constant">KING</span>, <span class="ruby-ivar">@wtm</span>
        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EMPTY</span>
        <span class="ruby-comment"># can&#39;t move through check</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_check?</span>
          <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">from</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">from</span>] = <span class="ruby-constant">KING</span>, <span class="ruby-ivar">@wtm</span>
          <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EMPTY</span>
          <span class="ruby-comment"># put the king back</span>
          <span class="ruby-ivar">@kings</span>[<span class="ruby-ivar">@wtm</span>] = <span class="ruby-identifier">from</span>

          <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># move the rook</span>
        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-constant">KING</span>, <span class="ruby-ivar">@wtm</span>
        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>] = <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EMPTY</span>
        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-constant">ROOK</span>, <span class="ruby-ivar">@wtm</span>

      <span class="ruby-comment"># king side castle</span>
      <span class="ruby-comment"># _ _ _ K _ x _ R -&gt;  _ _ _ _ _ R K _</span>
      <span class="ruby-comment"># a b c d e f g h     a b c d e f g h</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">from</span>

        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>] = <span class="ruby-constant">KING</span>, <span class="ruby-ivar">@wtm</span>
        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EMPTY</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_check?</span>
          <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">from</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">from</span>] = <span class="ruby-constant">KING</span>, <span class="ruby-ivar">@wtm</span>
          <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>] = <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EMPTY</span>

          <span class="ruby-ivar">@kings</span>[<span class="ruby-ivar">@wtm</span>] = <span class="ruby-identifier">from</span>

          <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-constant">KING</span>, <span class="ruby-ivar">@wtm</span>
        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EMPTY</span>
        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>] = <span class="ruby-constant">ROOK</span>, <span class="ruby-ivar">@wtm</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">PAWN</span>
    <span class="ruby-comment"># already know that we can make an en passant capture since @ep == the target square</span>
    <span class="ruby-comment"># so the &#39;to&#39; square and one step back is where the pawn is</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-constant">EP_CAPTURE</span>
      <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]] = <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EMPTY</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">to</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">90</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">to</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">30</span>
      <span class="ruby-comment"># only allows queen promotions</span>
      <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-constant">QUEEN</span>
      <span class="ruby-identifier">piece</span> = <span class="ruby-constant">QUEEN</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">descend!</span>

  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-root_unmake" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">root_unmake</span><span
            class="method-args">(from, to, piece, target, type)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Responsible for handling the reversal of irreversible moves, essentially
&#39;root_make&#39;, backwards</p>
          
          

          
          <div class="method-source-code" id="root_unmake-source">
            <pre><span class="ruby-comment"># File lib/chstr/move.rb, line 98</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">root_unmake</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">type</span>)

  <span class="ruby-identifier">ascend!</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">KING</span>
    <span class="ruby-ivar">@kings</span>[<span class="ruby-ivar">@wtm</span>] = <span class="ruby-identifier">from</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-constant">CASTLE</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">from</span>
        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>] = <span class="ruby-constant">ROOK</span>, <span class="ruby-ivar">@wtm</span>
        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EMPTY</span>

      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">from</span>
        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-constant">ROOK</span>, <span class="ruby-ivar">@wtm</span>
        <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>] = <span class="ruby-constant">EMPTY</span>, <span class="ruby-constant">EMPTY</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">PAWN</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-constant">EP_CAPTURE</span>
      <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span> <span class="ruby-operator">-</span> <span class="ruby-constant">FORWARD</span>[<span class="ruby-ivar">@wtm</span>]] = <span class="ruby-constant">PAWN</span>, <span class="ruby-ivar">@ntm</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">QUEEN</span>
      <span class="ruby-comment"># if the &#39;piece&#39; variable says pawn but what&#39;s on the board is a queen, it can be assumed</span>
      <span class="ruby-comment"># that it should be demoted</span>
      <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-constant">PAWN</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">from</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">from</span>] = <span class="ruby-identifier">piece</span>, <span class="ruby-ivar">@wtm</span>
  <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-identifier">target</span>

  <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-identifier">target</span> <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span> <span class="ruby-operator">?</span> <span class="ruby-constant">EMPTY</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@ntm</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-search" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">search</span><span
            class="method-args">(alpha, beta, depth, pv_node)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs a Principal Variation (NegaScout) search, a directional minimax
recursive algorithm and extension to Alpha Beta that facilitates pruning
with effective move ordering and null window searches (see <a
href="https://en.wikipedia.org/wiki/Principal_variation_search">en.wikipedia.org/wiki/Principal_variation_search</a>)</p>
          
          

          
          <div class="method-source-code" id="search-source">
            <pre><span class="ruby-comment"># File lib/chstr/search.rb, line 115</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">search</span>(<span class="ruby-identifier">alpha</span>, <span class="ruby-identifier">beta</span>, <span class="ruby-identifier">depth</span>, <span class="ruby-identifier">pv_node</span>)
  <span class="ruby-comment"># reach target depth</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">quiesce</span>(<span class="ruby-identifier">alpha</span>, <span class="ruby-identifier">beta</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">depth</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
  <span class="ruby-comment"># cache move list</span>
  <span class="ruby-ivar">@mv</span>[<span class="ruby-ivar">@ply</span>] = <span class="ruby-identifier">generate_moves</span>
  <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
  <span class="ruby-keyword">while</span> <span class="ruby-ivar">@mv</span>[<span class="ruby-ivar">@ply</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span> = <span class="ruby-ivar">@mv</span>[<span class="ruby-ivar">@ply</span>].<span class="ruby-identifier">pop</span>
    <span class="ruby-comment"># check if move puts self in check</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">make</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>)
    <span class="ruby-identifier">i</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">pv_node</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-ivar">@pv</span>[<span class="ruby-ivar">@ply</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">SQ_ID</span>[<span class="ruby-constant">SQ120</span>[<span class="ruby-value">1</span>][<span class="ruby-identifier">to</span>]]
      <span class="ruby-comment"># on principal variation, search full window</span>
      <span class="ruby-identifier">score</span> = <span class="ruby-operator">-</span><span class="ruby-identifier">search</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">beta</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">alpha</span>, <span class="ruby-identifier">depth</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-keyword">true</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># null window, scale depth down for moves that seem pointless</span>
      <span class="ruby-identifier">score</span> = <span class="ruby-operator">-</span><span class="ruby-identifier">search</span>(<span class="ruby-operator">-</span>(<span class="ruby-identifier">alpha</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>), <span class="ruby-operator">-</span><span class="ruby-identifier">alpha</span>, <span class="ruby-identifier">depth</span> <span class="ruby-operator">-</span> (<span class="ruby-value">1</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">i</span> <span class="ruby-operator">/</span> <span class="ruby-value">4</span>)), <span class="ruby-keyword">false</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">alpha</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">beta</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">pv_node</span>
          <span class="ruby-ivar">@pv</span>[<span class="ruby-ivar">@ply</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">SQ_ID</span>[<span class="ruby-constant">SQ120</span>[<span class="ruby-value">1</span>][<span class="ruby-identifier">to</span>]]
          <span class="ruby-comment"># still on principal variation just not the move we expected</span>
          <span class="ruby-identifier">score</span> = <span class="ruby-operator">-</span><span class="ruby-identifier">search</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">beta</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">alpha</span>, <span class="ruby-identifier">depth</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-keyword">true</span>)
        <span class="ruby-keyword">else</span>
          <span class="ruby-comment"># found something but still not the principal variation as that must come all of the way</span>
          <span class="ruby-comment"># from the root, but search a full window as it is interesting</span>
          <span class="ruby-identifier">score</span> = <span class="ruby-operator">-</span><span class="ruby-identifier">search</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">beta</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">score</span>, <span class="ruby-identifier">depth</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-keyword">false</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">unmake</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">alpha</span>
      <span class="ruby-ivar">@ht</span>[<span class="ruby-identifier">piece</span>][<span class="ruby-identifier">to</span>] <span class="ruby-operator">+=</span> <span class="ruby-ivar">@hrzn</span>

      <span class="ruby-keyword">return</span> <span class="ruby-identifier">beta</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">beta</span>
      <span class="ruby-identifier">alpha</span> = <span class="ruby-identifier">score</span>
      <span class="ruby-ivar">@kt</span>[<span class="ruby-ivar">@ply</span>][<span class="ruby-identifier">piece</span>][<span class="ruby-identifier">to</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">2</span><span class="ruby-operator">**</span><span class="ruby-ivar">@hrzn</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">pv_node</span>
        <span class="ruby-ivar">@kt</span>[<span class="ruby-ivar">@ply</span>][<span class="ruby-identifier">piece</span>][<span class="ruby-identifier">to</span>] <span class="ruby-operator">+=</span> <span class="ruby-ivar">@hrzn</span><span class="ruby-operator">**</span><span class="ruby-ivar">@hrzn</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@bt</span>[<span class="ruby-identifier">piece</span>][<span class="ruby-identifier">to</span>] <span class="ruby-operator">+=</span> <span class="ruby-ivar">@hrzn</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">alpha</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-to_fen" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">to_fen</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Translates the current gamestate to be stored in browser memory, so the
game can be recreated and the user&#39;s move can be applied</p>
          
          

          
          <div class="method-source-code" id="to_fen-source">
            <pre><span class="ruby-comment"># File lib/chstr.rb, line 85</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">to_fen</span>
  <span class="ruby-identifier">fen</span>, <span class="ruby-identifier">str</span>, <span class="ruby-identifier">num_empty</span> = [], <span class="ruby-string">&quot;&quot;</span>, <span class="ruby-value">0</span>
  <span class="ruby-comment"># translate piece positions and account for empty squares</span>
  <span class="ruby-constant">SQRND</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">row</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">col</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">col</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span>
        <span class="ruby-identifier">num_empty</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">next</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">str</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">num_empty</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">num_empty</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
      <span class="ruby-identifier">str</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">FEN_SQUARES</span>[<span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">col</span>]][<span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">col</span>]]
      <span class="ruby-identifier">num_empty</span> = <span class="ruby-value">0</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">str</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">num_empty</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">num_empty</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">fen</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">str</span>
    <span class="ruby-identifier">str</span>, <span class="ruby-identifier">num_empty</span> = <span class="ruby-string">&quot;&quot;</span>, <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">fen</span> = [<span class="ruby-identifier">fen</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;/&quot;</span>)]
  <span class="ruby-identifier">fen</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-string">&#39;w&#39;</span>, <span class="ruby-string">&#39;b&#39;</span>][<span class="ruby-ivar">@wtm</span>]
  <span class="ruby-comment"># append irreversibles to the fen array</span>
  <span class="ruby-constant">FEN_CASTLE</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">letter</span>, <span class="ruby-identifier">square</span><span class="ruby-operator">|</span> <span class="ruby-identifier">str</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">letter</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@castling</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">square</span>) }
  <span class="ruby-identifier">fen</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">str</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;-&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">str</span>
  <span class="ruby-identifier">fen</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@ep</span> <span class="ruby-operator">?</span> <span class="ruby-constant">SQ_ID</span>[<span class="ruby-ivar">@ep</span>] <span class="ruby-operator">:</span> <span class="ruby-string">&quot;-&quot;</span>
  <span class="ruby-identifier">fen</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@fifty</span>.<span class="ruby-identifier">to_s</span>
  <span class="ruby-identifier">fen</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@full_moves</span>.<span class="ruby-identifier">to_s</span>

  <span class="ruby-identifier">fen</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot; &quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-unmake" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">unmake</span><span
            class="method-args">(from, to, piece, target)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Reverse a reversible sub-root move</p>
          
          

          
          <div class="method-source-code" id="unmake-source">
            <pre><span class="ruby-comment"># File lib/chstr/move.rb, line 142</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">unmake</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>)
  <span class="ruby-identifier">ascend!</span>

  <span class="ruby-ivar">@kings</span>[<span class="ruby-ivar">@wtm</span>] = <span class="ruby-identifier">from</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">piece</span> <span class="ruby-operator">==</span> <span class="ruby-constant">KING</span>

  <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">from</span>], <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">from</span>] = <span class="ruby-identifier">piece</span>, <span class="ruby-ivar">@wtm</span>
  <span class="ruby-ivar">@squares</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-identifier">target</span>

  <span class="ruby-ivar">@colors</span>[<span class="ruby-identifier">to</span>] = <span class="ruby-identifier">target</span> <span class="ruby-operator">==</span> <span class="ruby-constant">EMPTY</span> <span class="ruby-operator">?</span> <span class="ruby-constant">EMPTY</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@ntm</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-valid_root_moves" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">valid_root_moves</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Selects root moves to send to the browser for the valid move square
highlighting effect</p>
          
          

          
          <div class="method-source-code" id="valid_root_moves-source">
            <pre><span class="ruby-comment"># File lib/chstr/move.rb, line 8</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">valid_root_moves</span>
  <span class="ruby-identifier">valid</span> = []

  <span class="ruby-identifier">generate_root_moves</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">move</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">rating</span> = <span class="ruby-identifier">move</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">attempt_move</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>)
      <span class="ruby-identifier">valid</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">move</span>

      <span class="ruby-identifier">descend!</span>
      <span class="ruby-comment"># deal with uncastling/ep/king position</span>
      <span class="ruby-identifier">root_unmake</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">piece</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">type</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">valid</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

